---
title: "Specific_queries"
author: "Leonard Orozco"
date: "2020年6月6日"
output: html_document
---

# A sample case of data querying

After understanding the basics, you may want to see an approach for querying a specific set. In this article, we take a look at how to use the package to determine and query for data in Alaska. 

## What we're looking for

We want to work with ozone concentrations in Alaska. In particular, we're looking to get data for the entire month of January in 2019. We might be able to see how to make the call easier by setting up these requirements as a bulleted list:

* Start data = January 1, 2019
* End date = January 31, 2019
* Pollutant = ozone
* State = Alaska

## What service to use

The EPA contains several services so we need to first determine what service to use 
to get these data. 

```{r}
library(rvest)
library(jsonlite)
library(httr)
library(epaGrabber)
```

```{r echo = FALSE}
authentication <- create.authentication( "glo003@bucknell.edu", "goldram72")
options( epa_authentication = authentication)
```

Using the smart variable selection in RStudio simplifies finding the service of interest. We type service.names$ and find out what services are listed. Since we're looking for data for a month, it might make sense to check out the daily summary services. 

```{r}
service.names$Daily.Summary
```

## The endpoint for the service

If we want to try using the daily summary service, we need to find an endpoint for it as well as the variables to fill. 

The services variable gives us the answer. We can easily select the Daily Summary Data option and subsequently find what endpoint we need to filter by state. 

```{r}
services$`Daily Summary Data`$Filter$`By State`
```
We can see the endpoint and the variables we need here.  Note that we don't need to include an email and key since the package already includes authentication credentials (see how to setup your authentication here). Also, we take care to declare the variable names with the exact name specified (e.g. state instead of State).

Date variables are easy to infer for the call, but it looks like we need to use a particular code for the state of Alaska, and for ozone. 

## Finding codes for variables 

We need to find the parameter code for Alaska. How might we do this? A service in the API migh help us here. 

```{r}
services$List$Description
```
Indeed, the list service description seems to fit our needs. We find out more about how to use the service. 

### The state code

After tooling around the filters, it looks like the State filter would give us the info we need to get state codes.

```{r}
services$List$Filter$States
```
It looks like we need only use the endpoint suggested to get the state codes. 

```{r}
endpoint <- "list/states"
call <- create.base.call( endpoint )
state.codes <- perform.call( call )
head( state.codes$Data )
```
Alaska shows up as 02 so we can now set that variable up in our call. 

### The parameter code

Now, we're left with determining the parameter code for ozone. Like we did to find the state code, we check out the listing service.

```{r}
services$List$Filter$`Parameters in a class (obtain the list of classes from the List - Parameter Classes service)`
```
We're close, but we don't really know what to make of the class variable above. Maybe it will make more sense to list the available classes available for a variable. 

TODO - Fix name of classes
TODO - Fix fix entries in table

```{r}
services$List$Filter$`https://aqs.epa.gov/data/api/list/classes?email=test@aqs.api&key=test`
```
After getting the endpoint, we can see the classes.

```{r}
endpoint <- "list/classes"
call <- create.base.call( endpoint )
manual.call <- call
classes <- perform.call( call )
head( classes$Data )
```
We're interested in finding codes for AQI POLLUTANTS since ozone sould classify as that. 
So, we would take this code and query for the parameters in this class. We recall the endpoint and required variables here.

```{r}
services$List$Filter$`Parameters in a class (obtain the list of classes from the List - Parameter Classes service)`
```
```{r}
endpoint <- "list/parametersByClass"
base.call <- create.base.call( endpoint )
pc <- "AQI%20POLLUTANTS"       # %20 represents the space between the two words
call <- add.variable( base.call, pc)
params <- perform.call( call )
params$Data
```
Bingo. Ozone has a code of 44201 so we can declare a variable for our original query. 

### Putting it all together

Recall that we set out to find data for the following:

* Start data = January 1, 2019
* End date = January 31, 2019
* Pollutant = ozone
* State = Alaska

We determined the endpoint and parameter codes to use for each value. Here we setup our variables based on our findings.

```{r}
endpoint <- "dailyData/byState"
vars <-  list(bdate = "20190101",
              edate = "20190131",
              param = "44201",    # Ozone, pc stands for parameter code
              state = "02")    # Alaska
```

We set up a variables list and make the call. The order variables go in the list doesn't matter.

```{r}
call <- create.base.call( endpoint )
call <- add.variables( call, vars )
alaska.call <- perform.call( call )
```
We can check the data is present as called. 

```{r}
alaska <- alaska.call$Data
nrow( alaska )
```
It may be too much to visually look over 248 rows and multiple columns so we instead look for the date variable and see that it has a day for each. 

```{r}
alaska$date_local
```
And indeed it does. You may have to look more closely that required data is present, but you now have ozone data for Alaska! 